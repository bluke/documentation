<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <link href="/assets/stylesheets/documentation.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/assets/javascripts/documentation.js" type="text/javascript"></script>
  </head>
  <body class='developers developers_api developers_api_v1 developers_api_v1_authentication developers_api_v1_authentication_index'>
    <header class='notice'>
      <p>En cas de problème avec la documentation, veuillez <a href="https://github.com/ares-ensiie/documentation/issues/new">ouvrir une issue</a> ou nous contacter sur <a href="irc://irc.iiens.net/%23ares">#ares</a></p>
    </header>
    <article>
      <h1>OAuth ARES</h1>&#x000A;&#x000A;<p>Dans un premier temps, il faut une application avec des <code>client_id</code> et <code>client_secret</code> </p>&#x000A;&#x000A;<h2>Obtenir un access token</h2>&#x000A;&#x000A;<p><em>Dans le protocole OAuth2, la procédure d&#39;obtention d&#39;un access</em>token se déroule en deux étapes, l&#39;authorization et la récupération du token._</p>&#x000A;&#x000A;<h3>Authorisation</h3>&#x000A;&#x000A;<p>La procédure d&#39;autorisation permet de demander à l&#39;utilisateur si il autorise votre application à accéder aux données que vous demandez.</p>&#x000A;&#x000A;<p>C&#39;est lors de cette étape que vous indiquez à quels informations vous souhaitez accéder. Par défaut, c&#39;est le scope <code>anonymous</code> qui est appliqué. Ce scope ne permet pas d&#39;identifier un utilisateur mais vous certifie seulement que cet utilisateur est membre de l&#39;école et vous donne accès à sa promotion.</p>&#x000A;&#x000A;<p>L&#39;autorisation se réalise avec une double redirection, vous redirigez l&#39;utilisateur vers une URL forgé, l&#39;utilisateur autorise votre application puis il est redirigé vers une URL que vous avez spécifié dans votre redirection avec un paramètre, le <code>code</code>.</p>&#x000A;&#x000A;<p>Les paramètres pour forger l&#39;URL sont :</p>&#x000A;<div class="highlight"><pre><span class="n">REDIRECTION</span> <span class="n">http</span><span class="o">:</span><span class="c1">//iiens.eu/oauth/authorize</span>&#x000A;</pre></div>&#x000A;<ul>&#x000A;<li><code>response_type</code> : doit avoir la valeur &ldquo;<code>code</code>&rdquo;</li>&#x000A;<li><code>client_id</code> : votre <code>client_id</code></li>&#x000A;<li><code>client_secret</code> : votre <code>client_secret</code></li>&#x000A;<li><code>scopes</code> : liste de scopes séparé par un plus <code>+</code></li>&#x000A;<li><code>redirect_uri</code> : adresse vers laquelle il faut rediriger l&#39;utilisateur après l&#39;authorisation.</li>&#x000A;</ul>&#x000A;&#x000A;<p>Le <code>code</code> n&#39;est valable que dix minutes.</p>&#x000A;&#x000A;<h2>Obtention du token</h2>&#x000A;&#x000A;<p>Une fois muni de votre code, vous pouvez faire la demande d&#39;un token d&#39;accès en à l&#39;aide d&#39;une simple requête POST.</p>&#x000A;<div class="highlight"><pre><span class="n">POST</span> <span class="n">http</span><span class="o">:</span><span class="c1">//iiens.eu/oauth/token</span>&#x000A;</pre></div>&#x000A;<ul>&#x000A;<li><code>client_id</code> : votre <code>client_id</code></li>&#x000A;<li><code>client_secret</code> : votre <code>client_secret</code></li>&#x000A;<li><code>code</code> : le code obtenu lors de l&#39;autorisation</li>&#x000A;<li><code>grant_type</code> : passer la valeur &ldquo;<code>authorization_code</code>&rdquo; pour l&#39;instant</li>&#x000A;<li><code>redirect_uri</code> : l&#39;adresse vers laquelle vous souhaitez que l&#39;utilisateur soit redirigé.</li>&#x000A;</ul>&#x000A;&#x000A;<h2>Liste des scopes</h2>&#x000A;&#x000A;<ul>&#x000A;<li>*<code>anonymous</code> : Donne accès à la promotion de l&#39;utilisateur</li>&#x000A;<li><code>identity</code> : Donne accès à l&#39;identité de l&#39;utilisateur, son nom, prénom, email, avatar…</li>&#x000A;</ul>&#x000A;&#x000A;<h2>Exemple</h2>&#x000A;&#x000A;<p>Commencez d&#39;abord par ajouter un lien pour se logger avec ARES.</p>&#x000A;<div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/auth/ares&quot;</span><span class="nt">&gt;</span>Se logger avec ARES<span class="nt">&lt;/a&gt;</span>&#x000A;</pre></div>&#x000A;<p>Definir des variables pour le <code>client_id</code>, le <code>client_secret</code> ainsi que le <code>redirect_uri</code></p>&#x000A;<div class="highlight"><pre><span class="n">oAuthClientId</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">EXAMPLE</span><span class="err">&#39;</span>&#x000A;<span class="n">oAuthClientSecret</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">EXAMPLE</span><span class="err">&#39;</span>&#x000A;<span class="n">oAuthRedirectUri</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//HOST/auth&#39;</span>&#x000A;</pre></div>&#x000A;<p>Les requêtes vers <code>/auth/ares</code> doivent initier le processus d&#39;autorisation.</p>&#x000A;<div class="highlight"><pre><span class="n">app</span><span class="p">.</span><span class="n">get</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">auth</span><span class="o">/</span><span class="n">ares</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;  <span class="n">res</span><span class="p">.</span><span class="n">redirect</span> <span class="s">&quot;http://iiens.eu/oauth/authorize?response_type=code&amp;client_id=#{oAuthClientId}&amp;client_secret=#{oAuthClientSecret}&amp;redirect_uri=#{redirect_uri}&quot;</span>&#x000A;</pre></div><div class="highlight"><pre><span class="n">app</span><span class="p">.</span><span class="n">get</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">auth</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;  <span class="n">code</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">param</span> <span class="err">&#39;</span><span class="n">code</span><span class="err">&#39;</span>&#x000A;  <span class="k">if</span> <span class="n">code</span>&#x000A;    <span class="n">request</span><span class="p">.</span><span class="n">post</span>&#x000A;      <span class="nl">url:</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//iiens.eu/oauth/token&#39;</span>&#x000A;      <span class="nl">form:</span>&#x000A;        <span class="nl">client_id:</span> <span class="n">oAuthClientId</span>&#x000A;        <span class="nl">client_secret:</span> <span class="n">oAuthClientSecret</span>&#x000A;        <span class="nl">grant_type:</span> <span class="err">&#39;</span><span class="n">authorization_code</span><span class="err">&#39;</span>&#x000A;        <span class="nl">redirect_uri:</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//sxb-or.herokuapp.com/auth&#39;</span>&#x000A;        <span class="nl">code:</span> <span class="n">code</span>&#x000A;      <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;        <span class="n">body</span> <span class="o">=</span> <span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>&#x000A;        <span class="n">unless</span> <span class="n">body</span><span class="p">.</span><span class="n">access_token</span><span class="o">?</span>&#x000A;          <span class="n">res</span><span class="p">.</span><span class="n">send</span> <span class="n">body</span>&#x000A;        <span class="k">else</span>&#x000A;          <span class="n">request</span>&#x000A;            <span class="nl">url:</span> <span class="s">&quot;http://api.iiens.eu/users/me?access_token=#{body.access_token}&quot;</span>&#x000A;            <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">currentUser</span><span class="p">)</span> <span class="o">-&gt;</span>&#x000A;              <span class="n">req</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">currentUser</span> <span class="o">=</span> <span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">currentUser</span><span class="p">)</span>&#x000A;              <span class="n">res</span><span class="p">.</span><span class="n">redirect</span> <span class="sc">&#39;/&#39;</span>&#x000A;</pre></div>
    </article>
  </body>
</html>
